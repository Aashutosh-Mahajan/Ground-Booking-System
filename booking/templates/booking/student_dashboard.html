{% extends 'base.html' %}
{% load static %}
{% block title %}Student Dashboard{% endblock %}

{% block content %}

<div class="dashboard-center">
    <h2 class="welcome-text">Welcome, {{ first_name }}</h2>
    <p class="welcome-subtext">Here is your dashboard to manage your ground bookings.</p>
</div>

<div class="note-box">
  <div class="note-content">
    <div class="note-accent"></div>
    <p class="note-text">
      <span class="note-text-red">NOTE :</span> KNOW YOUR GROUND AVAILABILITY ACCORDING TO YOUR TIME, SPORT, AND GROUND.
    </p>
  </div>
</div>

<div>
    <!-- Ground Booking Form Start -->
    <div class="booking-form">
        <!-- Date Selection -->
        <div class="form-section date-section">
            <h2 class="section-title">üìÖ Select Date</h2>
            <div class="date-picker">
                <input type="date" id="dateInput" min="" />
            </div>
        </div>

        <!-- Ground Selection -->
        <div class="form-section disabled" id="groundSection">
            <h2 class="section-title">üèüÔ∏è Choose Ground</h2>
            <div class="grounds-grid">
                <div class="ground-card" onclick="selectGround('A', event)">
                    <div class="ground-title">Ground A</div>
                    <div class="sports-list">
                        <span class="sport-tag">‚öΩ Football</span>
                        <span class="sport-tag">ü§∏ Kabaddi</span>
                    </div>
                </div>
                <div class="ground-card" onclick="selectGround('B', event)">
                    <div class="ground-title">Ground B</div>
                    <div class="sports-list">
                        <span class="sport-tag">üèè Cricket</span>
                        <span class="sport-tag">üèÄ Basketball</span>
                        <span class="sport-tag">üèÉ Athletics</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sport Selection -->
        <div class="form-section sports-section disabled" id="sportsSection">
            <h2 class="section-title">üèÉ Select Sport</h2>
            <div class="sports-grid" id="sportsGrid"></div>
        </div>

        <!-- Time Slots -->
        <div class="form-section disabled" id="timeSection">
            <h2 class="section-title">‚è∞ Choose Time Slot</h2>
            <div class="time-slots-grid" id="slotsGrid"></div>
        </div>

        <!-- Booking Summary -->
        <div class="booking-summary">
            <div class="summary-grid">
                <div class="summary-item">
                    <span>üìÖ Date:</span>
                    <strong id="summaryDate">Not selected</strong>
                </div>
                <div class="summary-item">
                    <span>üèüÔ∏è Ground:</span>
                    <strong id="summaryGround">Not selected</strong>
                </div>
                <div class="summary-item">
                    <span>üèÉ Sport:</span>
                    <strong id="summarySport">Not selected</strong>
                </div>
                <div class="summary-item">
                    <span>‚è∞ Time:</span>
                    <strong id="summaryTime">Not selected</strong>
                </div>
            </div>
            <button class="confirm-btn" id="confirmBtn" onclick="confirmBooking()" disabled>
                Confirm Booking
            </button>
        </div>
    </div>
</div>

<script>
let bookingData = { date: '', ground: '', sport: '', timeSlot: '' };

const groundSports = {
    'A': [{ name: 'Football', icon: '‚öΩ' }, { name: 'Kabaddi', icon: 'ü§∏' }],
    'B': [{ name: 'Cricket', icon: 'üèè' }, { name: 'Basketball', icon: 'üèÄ' }, { name: 'Athletics', icon: 'üèÉ' }]
};

// Set minimum date to today
document.getElementById('dateInput').min = new Date().toISOString().split('T')[0];

document.getElementById('dateInput').addEventListener('change', function () {
    bookingData.date = this.value;
    if (this.value) {
        document.getElementById('groundSection').classList.remove('disabled');
    } else {
        document.getElementById('groundSection').classList.add('disabled');
        document.getElementById('sportsSection').classList.add('disabled');
        document.getElementById('timeSection').classList.add('disabled');
        resetSelections();
    }
    updateSummary();
});

function selectGround(ground, event) {
    bookingData.ground = ground;
    bookingData.sport = '';
    bookingData.timeSlot = '';

    document.querySelectorAll('.ground-card').forEach(c => c.classList.remove('selected'));
    event.currentTarget.classList.add('selected');

    document.getElementById('sportsSection').classList.remove('disabled');
    populateSports(ground);

    document.getElementById('timeSection').classList.remove('disabled');
    fetchAvailability(ground);

    document.querySelectorAll('.sport-option, .time-slot').forEach(el => el.classList.remove('selected'));

    updateSummary();
}

function populateSports(ground) {
    const grid = document.getElementById('sportsGrid');
    grid.innerHTML = '';
    groundSports[ground].forEach(s => {
        const btn = document.createElement('button');
        btn.className = 'sport-option';
        btn.innerHTML = `${s.icon} ${s.name}`;
        btn.onclick = (e) => selectSport(s.name, e);
        grid.appendChild(btn);
    });
}

function selectSport(sport, event) {
    bookingData.sport = sport;
    document.querySelectorAll('.sport-option').forEach(o => o.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    updateSummary();
}

async function fetchAvailability(ground) {
    const dateInput = document.getElementById('dateInput');
    const date = dateInput ? dateInput.value : null;

    if (!date) { alert("Please select a date first!"); return; }

    try {
        const res = await fetch("{% url 'check_availability' %}?date=" + date + "&ground=" + ground);
        const data = await res.json();

        const grid = document.getElementById('slotsGrid');
        grid.innerHTML = '';

        data.slots.forEach(slot => {
            const div = document.createElement('div');
            div.className = 'time-slot';
            div.textContent = slot.time;

            if (slot.status === "booked") {
                div.classList.add('booked');
                div.title = 'This slot is already booked';
            } else if (slot.status === "available") {
                div.classList.add('available');
                div.onclick = (e) => selectTimeSlot(slot.time, e);
            } else {
                div.classList.add('disabled');
                div.title = 'Unavailable';
            }

            grid.appendChild(div);
        });

    } catch (error) { console.error("Error fetching slots:", error); }
}

function selectTimeSlot(slot, event) {
    bookingData.timeSlot = slot;
    document.querySelectorAll('.time-slot:not(.booked)').forEach(s => s.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    updateSummary();
}

function resetSelections() {
    bookingData = { date: '', ground: '', sport: '', timeSlot: '' };
    document.querySelectorAll('.ground-card,.sport-option,.time-slot').forEach(el => el.classList.remove('selected'));
}

function updateSummary() {
    document.getElementById('summaryDate').textContent = bookingData.date ? new Date(bookingData.date).toDateString() : 'Not selected';
    document.getElementById('summaryGround').textContent = bookingData.ground ? `Ground ${bookingData.ground}` : 'Not selected';
    document.getElementById('summarySport').textContent = bookingData.sport || 'Not selected';
    document.getElementById('summaryTime').textContent = bookingData.timeSlot || 'Not selected';
    document.getElementById('confirmBtn').disabled = !(bookingData.date && bookingData.ground && bookingData.sport && bookingData.timeSlot);
}

function confirmBooking() {
    if (bookingData.date && bookingData.ground && bookingData.sport && bookingData.timeSlot) {
        // Redirect to booking page with query params
        const params = new URLSearchParams({
            date: bookingData.date,
            ground: bookingData.ground,
            sport: bookingData.sport,
            time_slot: bookingData.timeSlot
        }).toString();
        window.location.href = `{% url 'student_booking' %}?${params}`;
    }
}
async function fetchAvailability(ground) {
    const dateInput = document.getElementById('dateInput');
    const date = dateInput ? dateInput.value : null;

    if (!date) { alert("Please select a date first!"); return; }

    const grid = document.getElementById('slotsGrid');
    grid.innerHTML = '<div class="loading">Loading...</div>';  // ‚úÖ show loading

    try {
        const res = await fetch("{% url 'check_availability' %}?date=" + date + "&ground=" + ground);
        const data = await res.json();

        grid.innerHTML = '';  // clear loading

        data.slots.forEach(slot => {
            const div = document.createElement('div');
            div.className = 'time-slot';
            div.textContent = slot.time;

            if (slot.status === "booked") {
                div.classList.add('booked');
                div.title = 'This slot is already booked';
            } else if (slot.status === "available") {
                div.classList.add('available');
                div.onclick = (e) => selectTimeSlot(slot.time, e);
            } else {
                div.classList.add('disabled');
                div.title = 'Unavailable';
            }

            grid.appendChild(div);
        });

    } catch (error) {
        console.error("Error fetching slots:", error);
        grid.innerHTML = '<div class="error">Failed to load slots</div>';
    }
}

</script>

{% endblock %}
