{% extends 'base.html' %}
{% load static %}
{% block title %}Student Dashboard{% endblock %}

{% block content %}

<div class="dashboard-center">
    <h2 class="welcome-text">Welcome, {{ first_name }}</h2>
    <p class="welcome-subtext">Here is your dashboard to manage your ground bookings.</p>
</div>

<div class="note-box">
  <div class="note-content">
    <div class="note-accent"></div>
    <p class="note-text">
      <span class="note-text-red">NOTE :</span> KNOW YOUR GROUND AVAILABILITY ACCORDING TO YOUR TIME, SPORT, AND GROUND.
    </p>
  </div>
</div>

<div>
    <!-- Ground Booking Form Start -->
    <div class="booking-form">
        <!-- Date Selection -->
        <div class="form-section date-section">
            <h2 class="section-title">üìÖ Select Date</h2>
            <div class="date-picker">
                <input type="date" id="dateInput" min="" />
            </div>
        </div>

        <!-- Ground Selection -->
        <div class="form-section disabled" id="groundSection">
            <h2 class="section-title">üèüÔ∏è Choose Ground</h2>
            <div class="grounds-grid">
                <div class="ground-card" onclick="selectGround('A', event)">
                    <div class="ground-title">Ground A</div>
                    <div class="sports-list">
                        <span class="sport-tag">ü§æ Handball</span>
                        <span class="sport-tag">üèê Volleyball</span>
                        <span class="sport-tag">üèè Cricket</span>
                        <span class="sport-tag">üèÄ Basketball</span>
                    </div>
                </div>
                <div class="ground-card" onclick="selectGround('B', event)">
                    <div class="ground-title">Ground B</div>
                    <div class="sports-list">
                        <span class="sport-tag">‚öΩ Football</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sport Selection -->
        <div class="form-section sports-section disabled" id="sportsSection">
            <h2 class="section-title">üèÉ Select Sport</h2>
            <div class="sports-grid" id="sportsGrid"></div>

            <!-- ‚úÖ Equipment Card -->
            <div id="equipmentSection" class="equipment-card hidden">
                <label class="equipment-label">
                    <input type="checkbox" id="equipmentCheckbox" checked>
                    Need equipment? (Yes/No)
                </label>
                <div id="equipmentField" class="equipment-field">
                    <textarea id="equipmentInput" readonly></textarea>
                </div>
            </div>
        </div>

        <!-- Time Slots -->
        <div class="form-section disabled" id="timeSection">
            <h2 class="section-title">‚è∞ Choose Time Slot</h2>
            <div class="time-slots-grid" id="slotsGrid"></div>
        </div>

        <!-- Booking Summary -->
        <div class="booking-summary">
            <div class="summary-grid">
                <div class="summary-item">
                    <span>üìÖ Date:</span>
                    <strong id="summaryDate">Not selected</strong>
                </div>
                <div class="summary-item">
                    <span>üèüÔ∏è Ground:</span>
                    <strong id="summaryGround">Not selected</strong>
                </div>
                <div class="summary-item">
                    <span>üèÉ Sport:</span>
                    <strong id="summarySport">Not selected</strong>
                </div>
                <div class="summary-item">
                    <span>‚è∞ Time:</span>
                    <strong id="summaryTime">Not selected</strong>
                </div>
                <div class="summary-item">
                    <span>üéí Equipment:</span>
                    <strong id="summaryEquipment">Yes (default)</strong>
                </div>
            </div>
            <button class="confirm-btn" id="confirmBtn" onclick="confirmBooking()" disabled>
                Confirm Booking
            </button>
        </div>
    </div>
</div>

<script>
let bookingData = { date: '', ground: '', sport: '', timeSlot: '', equipment: 'Yes' };

const groundSports = {
    'A': [
        { name: 'Handball', icon: 'ü§æ' },
        { name: 'Volleyball', icon: 'üèê' },
        { name: 'Cricket', icon: 'üèè' },
        { name: 'Basketball', icon: 'üèÄ' }
    ],
    'B': [
        { name: 'Football', icon: '‚öΩ' }
    ]
};

// Set minimum date to today
document.getElementById('dateInput').min = new Date().toISOString().split('T')[0];

document.getElementById('dateInput').addEventListener('change', function () {
    bookingData.date = this.value;
    if (this.value) {
        document.getElementById('groundSection').classList.remove('disabled');
    } else {
        document.getElementById('groundSection').classList.add('disabled');
        document.getElementById('sportsSection').classList.add('disabled');
        document.getElementById('timeSection').classList.add('disabled');
        resetSelections();
    }
    updateSummary();
});

function selectGround(ground, event) {
    bookingData.ground = ground;
    bookingData.sport = '';
    bookingData.timeSlot = '';
    bookingData.equipment = 'Yes';

    document.querySelectorAll('.ground-card').forEach(c => c.classList.remove('selected'));
    event.currentTarget.classList.add('selected');

    document.getElementById('sportsSection').classList.remove('disabled');
    populateSports(ground);

    // don't fetch time slots yet ‚Äî wait for sport selection because slots depend on sport
    document.getElementById('timeSection').classList.add('disabled');

    document.querySelectorAll('.sport-option, .time-slot').forEach(el => el.classList.remove('selected'));

    updateSummary();
}

function populateSports(ground) {
    const grid = document.getElementById('sportsGrid');
    grid.innerHTML = '';
    groundSports[ground].forEach(s => {
        const btn = document.createElement('button');
        btn.className = 'sport-option';
        btn.innerHTML = `${s.icon} ${s.name}`;
        btn.onclick = (e) => selectSport(s.name, e);
        grid.appendChild(btn);
    });
}

function selectSport(sport, event) {
    bookingData.sport = sport;
    document.querySelectorAll('.sport-option').forEach(o => o.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    updateSummary();

    // ‚úÖ Show equipment section
    const equipSection = document.getElementById('equipmentSection');
    const equipInput = document.getElementById('equipmentInput');
    equipSection.classList.remove('hidden');

    // ‚úÖ Autofill equipment text rules
    if (sport === "Football") {
        equipInput.value = "1. Football\n2. Cones and Marker";
    } else if (sport === "Cricket") {
        equipInput.value = "Stumps";
    } else {
        equipInput.value = sport;
    }

    // Default checked
    document.getElementById('equipmentCheckbox').checked = true;
    document.getElementById('equipmentField').style.display = "block";
    bookingData.equipment = 'Yes';
    updateSummary();

    // Now that sport is selected, enable time section and fetch availability for the chosen ground
    if (bookingData.ground) {
        document.getElementById('timeSection').classList.remove('disabled');
        fetchAvailability(bookingData.ground);
    }
}

// ‚úÖ Toggle equipment field
document.getElementById('equipmentCheckbox').addEventListener('change', function() {
    const field = document.getElementById('equipmentField');
    if (this.checked) {
        field.style.display = "block";
        bookingData.equipment = 'Yes';
    } else {
        field.style.display = "none";
        bookingData.equipment = 'No';
    }
    updateSummary();
});

async function fetchAvailability(ground) {
    const dateInput = document.getElementById('dateInput');
    const date = dateInput ? dateInput.value : null;

    if (!date) { alert("Please select a date first!"); return; }

    const grid = document.getElementById('slotsGrid');
    grid.innerHTML = '<div class="loading">Loading...</div>';

    try {
        const res = await fetch("{% url 'check_availability' %}?date=" + date + "&ground=" + ground);
        const data = await res.json();

        grid.innerHTML = '';
        // Only show the two allowed combined slots. Use server small-slot
        // statuses to determine if any part of the allowed slot is booked.
        const allowedSlots = ["7:00 AM - 9:00 AM", "4:00 PM - 6:00 PM"];

        function parseTimeToMinutesJS(tstr) {
            tstr = tstr.trim();
            // handle AM/PM
            const ampmMatch = tstr.match(/(\d{1,2}:?\d{0,2})\s*(AM|PM)/i);
            if (ampmMatch) {
                let time = ampmMatch[1];
                if (!time.includes(':')) time = time + ':00';
                const [h, m] = time.split(':').map(x => parseInt(x, 10));
                let hh = h % 12;
                if (/PM/i.test(ampmMatch[2])) hh += 12;
                return hh * 60 + (m || 0);
            }
            // handle 24h like 07:00
            const parts = tstr.split(':');
            if (parts.length === 2) {
                const hh = parseInt(parts[0], 10);
                const mm = parseInt(parts[1], 10) || 0;
                return hh * 60 + mm;
            }
            return null;
        }

        function parseRangeJS(rng) {
            const parts = rng.split('-');
            if (parts.length < 2) return [null, null];
            const a = parts[0].trim();
            const b = parts[1].trim();
            return [parseTimeToMinutesJS(a), parseTimeToMinutesJS(b)];
        }

        // build a small-slot map from server data for quick checking
        const serverSlots = data.slots || [];

        allowedSlots.forEach(allowed => {
            const div = document.createElement('div');
            div.className = 'time-slot';
            div.textContent = allowed;

            const [allowedS, allowedE] = parseRangeJS(allowed);
            let booked = false;
            if (allowedS !== null && allowedE !== null) {
                for (const s of serverSlots) {
                    const [ss, se] = parseRangeJS(s.time);
                    if (ss === null || se === null) continue;
                    // overlap
                    if (ss < allowedE && allowedS < se) {
                        if (s.status === 'booked') { booked = true; break; }
                    }
                }
            }

            if (booked) {
                div.classList.add('booked');
                div.title = 'This slot is already booked';
            } else {
                div.classList.add('available');
                div.onclick = (e) => selectTimeSlot(allowed, e);
            }

            grid.appendChild(div);
        });

    } catch (error) {
        console.error("Error fetching slots:", error);
        grid.innerHTML = '<div class="error">Failed to load slots</div>';
    }
}

function selectTimeSlot(slot, event) {
    bookingData.timeSlot = slot;
    document.querySelectorAll('.time-slot:not(.booked)').forEach(s => s.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
    updateSummary();
}

function resetSelections() {
    bookingData = { date: '', ground: '', sport: '', timeSlot: '', equipment: 'Yes' };
    document.querySelectorAll('.ground-card,.sport-option,.time-slot').forEach(el => el.classList.remove('selected'));
}

function updateSummary() {
    document.getElementById('summaryDate').textContent = bookingData.date ? new Date(bookingData.date).toDateString() : 'Not selected';
    document.getElementById('summaryGround').textContent = bookingData.ground ? `Ground ${bookingData.ground}` : 'Not selected';
    document.getElementById('summarySport').textContent = bookingData.sport || 'Not selected';
    document.getElementById('summaryTime').textContent = bookingData.timeSlot || 'Not selected';
    document.getElementById('summaryEquipment').textContent = bookingData.equipment;
    document.getElementById('confirmBtn').disabled = !(bookingData.date && bookingData.ground && bookingData.sport && bookingData.timeSlot);
}

function confirmBooking() {
    if (bookingData.date && bookingData.ground && bookingData.sport && bookingData.timeSlot) {
        const params = new URLSearchParams({
            date: bookingData.date,
            ground: bookingData.ground,
            sport: bookingData.sport,
            time_slot: bookingData.timeSlot,
            equipment: bookingData.equipment
        }).toString();
        window.location.href = `{% url 'student_booking' %}?${params}`;
    }
}
</script>

<style>
.hidden { display: none; }

/* Equipment Card */
.equipment-card {
    margin-top: 20px;
    padding: 15px;
    border: 1px solid #e5e7eb;
    border-radius: 10px;
    background-color: #f9fafb;
}

.equipment-label {
    font-size: 16px;
    font-weight: 500;
    color: #374151;
    display: flex;
    align-items: center;
    gap: 8px;
}

.equipment-card input[type="checkbox"] {
    transform: scale(1.2);
    accent-color: #2563eb;
    cursor: pointer;
}

.equipment-field {
    margin-top: 12px;
}

.equipment-field textarea {
    width: 100%;
    height: 80px;
    padding: 12px 14px;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    font-size: 16px;
    color: #111827;
    background-color: #fff;
    resize: none;
}

/* Time slot states */
.time-slot.booked {
    background-color: #fecaca; /* light red */
    border-color: #f87171;
    color: #721c24;
    cursor: not-allowed;
    pointer-events: none; /* make unclickable */
}
.time-slot.freeze {
    background-color: #e5e7eb; /* grey */
    color: #6b7280;
    cursor: not-allowed;
}
.time-slot.available {
    cursor: pointer;
}

/* Larger green style for the allowed combined slots */
.time-slot.available {
    background-color: #bbf7d0; /* light green */
    border: 1px solid #34d399;
    color: #065f46;
    padding: 12px 18px;
    font-weight: 600;
}
.time-slot.booked {
    background-color: #fecaca; /* light red */
    border-color: #f87171;
    color: #7f1d1d;
}
.time-slot { border-radius: 6px; display: inline-block; margin-right: 12px; }
</style>

{% endblock %}
