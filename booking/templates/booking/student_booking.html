{% extends 'base.html' %}
{% load static %}
{% block title %}Book Ground{% endblock %}
{% block content %}

<div class="max-w-4xl mx-auto py-12 px-4">
    <div class="card p-8 shadow-lg">
        <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">Book a Ground</h2>

        <!-- Ground & Date Selection -->
        <div class="mb-4">
            <label class="block text-gray-700 font-medium">Select Ground</label>
            {{ booking_form.ground }}
        </div>

        <div class="mb-4">
            <label class="block text-gray-700 font-medium">Select Date</label>
            {{ booking_form.date }}
        </div>

        <!-- Time Slots -->
        <div id="slot-container" class="mt-4">
            <p class="text-gray-600">Select a ground & date to see available slots.</p>
        </div>

        <!-- Booking Form -->
        <form method="POST" action="{% url 'student_booking' %}" id="bookingForm" class="mt-6">
            {% csrf_token %}

            <!-- Hidden values filled by JS -->
            <input type="hidden" name="ground" id="groundField">
            <input type="hidden" name="date" id="dateField">
            <input type="hidden" name="time_slot" id="slotField">

            <!-- Student Info -->
            <div class="mb-4">
                <label class="block text-gray-700 font-medium">Student Name</label>
                <input type="text" name="student_name" class="input w-full border rounded p-2" required>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 font-medium">Student Email</label>
                <input type="email" name="student_email" class="input w-full border rounded p-2" required>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 font-medium">Roll Number</label>
                <input type="text" name="roll_number" class="input w-full border rounded p-2" required>
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 font-medium">Purpose</label>
                <textarea name="purpose" class="input w-full border rounded p-2" rows="3" required></textarea>
            </div>

            <div class="mb-6">
                <label class="block text-gray-700 font-medium">Number of Players</label>
                <input type="number" name="number_of_players" class="input w-full border rounded p-2" min="1" required>
            </div>

            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg shadow">
                Confirm Booking
            </button>
        </form>
    </div>
</div>

<script>
    function loadSlots() {
        const ground = document.getElementById("id_ground").value;
        const date = document.getElementById("id_date").value;

        // Update hidden fields
        document.getElementById("groundField").value = ground;
        document.getElementById("dateField").value = date;

        if (ground && date) {
            fetch(`/check_availability/?ground=${ground}&date=${date}`)
                .then(res => res.json())
                .then(data => {
                    let html = "<h3 class='font-bold mb-2'>Available Slots</h3>";
                    data.availability.forEach(slot => {
                        let colorClass = "";
                        let disabled = "";

                        if (slot.status === "available") {
                            colorClass = "bg-green-200 hover:bg-green-300 cursor-pointer";
                        } else if (slot.status === "booked") {
                            colorClass = "bg-red-200 cursor-not-allowed";
                            disabled = "disabled";
                        } else {
                            colorClass = "bg-blue-200 cursor-not-allowed";
                            disabled = "disabled";
                        }

                        html += `
                            <label class="block p-2 ${colorClass} rounded mb-2">
                                <input type="radio" name="time_slot_choice" value="${slot.time}" ${disabled}
                                    onchange="selectSlot('${slot.time}', '${slot.status}')"> 
                                ${slot.time}
                            </label>
                        `;
                    });
                    document.getElementById("slot-container").innerHTML = html;
                });
        }
    }

    function selectSlot(slot, status) {
        if (status === "booked") {
            alert(`‚ùå Ground already booked for ${slot}`);
            document.getElementById("slotField").value = "";
        } else if (status === "available") {
            document.getElementById("slotField").value = slot;
        }
    }

    document.getElementById("id_ground").addEventListener("change", loadSlots);
    document.getElementById("id_date").addEventListener("change", loadSlots);
</script>

{% endblock %}
