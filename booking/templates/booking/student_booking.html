{% extends 'base.html' %}
{% block title %}Book Ground{% endblock %}
{% block content %}

<div class="mx-auto py-12 px-8" style="max-width: 1600px;">
    <div class="card w-full">
        <h2 class="text-3xl font-bold text-gray-900 mb-8 text-center">Book a Ground</h2>

        <!-- Display Messages -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} mb-4 p-4 rounded-lg">
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        <form method="POST" action="{% url 'student_booking' %}" class="space-y-6">
            {% csrf_token %}

            <!-- Step 1 hidden inputs -->
            <input type="hidden" name="date" value="{{ request.GET.date }}">
            <input type="hidden" name="ground" value="{{ request.GET.ground }}">
            <input type="hidden" name="sport" value="{{ request.GET.sport }}">
            <input type="hidden" name="time_slot" value="{{ request.GET.time_slot }}">
            <!-- equipment may come as 'equipment' or 'equipment_selected' depending on flow -->
            <input type="hidden" name="equipment" value="{{ request.GET.equipment }}">

            <!-- Optional summary of Step 1 selections -->
            <div class="booking-summary">
                <p><strong>Date:</strong> {{ request.GET.date }}</p>
                <p><strong>Ground:</strong> {{ request.GET.ground }}</p>
                <p><strong>Sport:</strong> {{ request.GET.sport }}</p>
                <p><strong>Time Slot:</strong> {{ request.GET.time_slot }}</p>
            </div>

            <!-- Student Information -->
            <div class="grid grid-cols-3 gap-6">
                <div class="form-group">
                    <label class="form-label">Main Student Name</label>
                    {{ booking_form.student_name }}
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    {{ booking_form.student_email }}
                </div>
                <div class="form-group">
                    <label class="form-label">Number of Players</label>
                    <select name="number_of_players" id="id_number_of_players" class="form-select">
                        {% for i in number_options %}
                            <option value="{{ i }}" {% if i == 1 %}selected{% endif %}>{{ i }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <!-- Equipment Selected -->
            <div class="form-group" id="equipment-section" style="display: none;">
                <label class="form-label">Equipment Selected</label>
                <textarea id="equipmentField" name="equipment_selected" class="form-input" readonly rows="3"></textarea>
            </div>

            <!-- Purpose -->
            <div class="form-group">
                <label class="form-label">Purpose</label>
                {{ booking_form.purpose }}
            </div>

            <!-- Player Selection -->
            <div id="players-container" class="space-y-4">
                <div class="form-group">
                    <label class="form-label">Add Players</label>
                    <div class="relative">
                        <input type="text" id="playerSearchInput" class="form-input" placeholder="Type first name to search players...">
                        <div id="playerSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg hidden max-h-60 overflow-y-auto mt-1"></div>
                    </div>
                </div>
                
                <div id="selectedPlayers" class="space-y-2"></div>
            </div>

            <!-- Submit -->
            <button type="submit" class="btn btn-primary btn-full">
                Submit Booking Request
            </button>
        </form>
    </div>
</div>

<!-- Auto-fill Equipment Field -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const sport = "{{ request.GET.sport|escapejs }}";
    const equipmentField = document.getElementById('equipmentField');
    const equipmentSection = document.getElementById('equipment-section');

    // Map sport -> equipment
    const equipmentMap = {
        "Football": ["Football", "Cones and Marker"],   // special case: multiple
        "Basketball": ["Basketball"],
        "Volleyball": ["Volleyball"],
        "Handball": ["Handball"],
        "Cricket": ["Stumps"]
    };

    if (sport && equipmentMap[sport]) {
        let equipmentList;

        if (sport === "Football") {
            // Special formatting for Football
            equipmentList = equipmentMap[sport]
                .map((item, index) => `${index + 1}. ${item}`)
                .join("\n");
        } else {
            // Default: single equipment
            equipmentList = equipmentMap[sport][0];
        }

        equipmentField.value = equipmentList;
        equipmentSection.style.display = 'block';
    } else {
        equipmentSection.style.display = 'none';
    }
});
</script>

<!-- Player Search and Selection Script -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const playerSearchInput = document.getElementById('playerSearchInput');
    const playerSuggestions = document.getElementById('playerSuggestions');
    const selectedPlayers = document.getElementById('selectedPlayers');
    const numPlayersSelect = document.getElementById('id_number_of_players');
    
    let selectedPlayersList = [];
    let playerCounter = 1;

    // Search for players by first name (starts from first letter)
    playerSearchInput.addEventListener('input', function() {
        const query = this.value.trim();
        if (query.length >= 1) { // Changed from > 1 to >= 1 to start from first letter
            fetch(`/fetch-student-data/?q=${query}`)
                .then(response => response.json())
                .then(data => {
                    displaySuggestions(data);
                })
                .catch(error => {
                    console.error('Error fetching student data:', error);
                });
        } else {
            playerSuggestions.classList.add('hidden');
            playerSuggestions.innerHTML = '';
        }
    });

    // Hide suggestions when clicking outside
    document.addEventListener('click', function(event) {
        if (!playerSearchInput.contains(event.target) && !playerSuggestions.contains(event.target)) {
            playerSuggestions.classList.add('hidden');
            playerSuggestions.innerHTML = '';
        }
    });

    // Show suggestions when input is focused and has content
    playerSearchInput.addEventListener('focus', function() {
        const query = this.value.trim();
        if (query.length >= 1) {
            fetch(`/fetch-student-data/?q=${query}`)
                .then(response => response.json())
                .then(data => {
                    displaySuggestions(data);
                })
                .catch(error => {
                    console.error('Error fetching student data:', error);
                });
        }
    });

    function displaySuggestions(students) {
        playerSuggestions.innerHTML = '';
        if (students.length > 0) {
            students.forEach(student => {
                const suggestionDiv = document.createElement('div');
                suggestionDiv.className = 'p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-200';
                suggestionDiv.innerHTML = `
                    <div class="font-medium">${student.full_name}</div>
                    <div class="text-sm text-gray-600">${student.email} | ${student.branch} - ${student.year}${student.division}${student.roll_number ? ` | ${student.roll_number}` : ''}</div>
                `;
                suggestionDiv.addEventListener('click', () => {
                    addPlayer(student);
                    playerSearchInput.value = '';
                    playerSuggestions.classList.add('hidden');
                    playerSuggestions.innerHTML = '';
                });
                playerSuggestions.appendChild(suggestionDiv);
            });
            playerSuggestions.classList.remove('hidden');
        } else {
            playerSuggestions.classList.add('hidden');
        }
    }

    function addPlayer(student) {
        console.log('Adding player:', student);
        console.log('Current selected players:', selectedPlayersList);
        
        // Check if player is already selected (more robust comparison)
        const isAlreadyAdded = selectedPlayersList.some(p => {
            // Check by email (primary identifier)
            if (p.email && student.email && p.email === student.email) {
                console.log('Match found by email:', p.email);
                return true;
            }
            // Check by roll number if available (secondary identifier)
            if (p.roll_number && student.roll_number && p.roll_number === student.roll_number) {
                console.log('Match found by roll number:', p.roll_number);
                return true;
            }
            // Check by full name as last resort (but only if both have names)
            if (p.full_name && student.full_name && p.full_name === student.full_name) {
                console.log('Match found by name:', p.full_name);
                return true;
            }
            return false;
        });
        
        if (isAlreadyAdded) {
            alert('This player is already added!');
            return;
        }

        // Check if we've reached the maximum number of players
        const maxPlayers = parseInt(numPlayersSelect.value);
        if (selectedPlayersList.length >= maxPlayers) {
            alert(`You can only add ${maxPlayers} players.`);
            return;
        }

        selectedPlayersList.push(student);
        displaySelectedPlayers();
    }

    function displaySelectedPlayers() {
        selectedPlayers.innerHTML = '';
        selectedPlayersList.forEach((player, index) => {
            const playerDiv = document.createElement('div');
            playerDiv.className = 'flex items-center justify-between p-3 bg-gray-50 rounded-lg border';
            playerDiv.innerHTML = `
                <div class="flex-1">
                    <div class="font-medium">${player.full_name}</div>
                    <div class="text-sm text-gray-600">${player.email} | ${player.branch} - ${player.year}${player.division}${player.roll_number ? ` | ${player.roll_number}` : ''}</div>
                </div>
                <button type="button" onclick="removePlayer(${index})" class="text-red-600 hover:text-red-800 font-bold text-lg">Ã—</button>
            `;
            selectedPlayers.appendChild(playerDiv);
        });
    }

    // Global function to remove players
    window.removePlayer = function(index) {
        selectedPlayersList.splice(index, 1);
        displaySelectedPlayers();
    };

    // Update when number of players changes
    numPlayersSelect.addEventListener('change', function() {
        const maxPlayers = parseInt(this.value);
        if (selectedPlayersList.length > maxPlayers) {
            selectedPlayersList = selectedPlayersList.slice(0, maxPlayers);
            displaySelectedPlayers();
        }
    });

    // Add hidden inputs for selected players before form submission
    document.querySelector('form').addEventListener('submit', function(e) {
        // Ensure number_of_players matches selected list length
        const numSelect = document.getElementById('id_number_of_players');
        if (numSelect) {
            numSelect.value = String(selectedPlayersList.length);
        }

        // Remove any existing player inputs
        document.querySelectorAll('input[name^="player"]').forEach(input => input.remove());
        
        // Add hidden inputs for selected players
        selectedPlayersList.forEach((player, index) => {
            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = `player${index + 1}_name`;
            hiddenInput.value = player.email; // Using email as identifier
            this.appendChild(hiddenInput);
        });
    });
});
</script>

<style>
.alert {
    border: 1px solid;
    border-radius: 0.5rem;
    padding: 1rem;
    margin-bottom: 1rem;
}

.alert-error {
    background-color: #fef2f2;
    border-color: #fecaca;
    color: #dc2626;
}

.alert-success {
    background-color: #f0fdf4;
    border-color: #bbf7d0;
    color: #16a34a;
}

.alert-warning {
    background-color: #fffbeb;
    border-color: #fed7aa;
    color: #d97706;
}

.alert-info {
    background-color: #eff6ff;
    border-color: #bfdbfe;
    color: #2563eb;
}
</style>

{% endblock %}
