{% extends 'base.html' %}
{% load static %}
{% block title %}My Booking History{% endblock %}

{% block content %}
<style>
  .history-card { background: #ffffff; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.06); padding: 24px; }
  .history-title { font-size: 2rem; font-weight: 800; letter-spacing: .2px; margin: 8px 0 4px; }
  .history-subtitle { color: #6b7280; margin: 0 0 18px; }
  .history-table { width: 100%; border-collapse: separate; border-spacing: 0 12px; }
  .history-table thead th { font-size: .95rem; color: #6b7280; font-weight: 700; text-transform: uppercase; letter-spacing: .04em; padding: 10px 14px; }
  .history-row { background: #f9fafb; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.04); }
  .history-row > td { padding: 16px 14px; font-size: 1rem; }
  .status-badge { padding: 6px 10px; border-radius: 999px; font-weight: 700; font-size: .9rem; }
  .status-approved { background: #dcfce7; color: #166534; }
  .status-rejected { background: #fee2e2; color: #991b1b; }
  .status-pending { background: #fef9c3; color: #854d0e; }
  .players-toggle { appearance: none; background: #1e40af; color: white; border: none; border-radius: 10px; padding: 8px 12px; font-weight: 700; cursor: pointer; transition: transform .05s ease; }
  .players-toggle:active { transform: translateY(1px); }
  .players-panel { display: none; background: #ffffff; border: 1px solid #e5e7eb; border-radius: 12px; padding: 14px; margin: 8px 4px 2px; }
  .players-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 10px; }
  .player-chip { background: #f1f5f9; border-radius: 10px; padding: 10px 12px; font-size: .95rem; display: flex; flex-direction: column; gap: 2px; }
  .player-chip strong { color: #111827; }
  .filters-wrap { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 14px; }
  .filters-wrap select { padding: 8px 10px; border-radius: 10px; border: 1px solid #d1d5db; font-weight: 600; }
  .pagination a, .pagination span.btn { background: #111827; color: white; padding: 8px 12px; border-radius: 10px; text-decoration: none; font-weight: 700; }
  .pagination { display:flex; gap:.5rem; align-items:center; margin-top:1rem; }
  @media (max-width: 768px) {
    .history-title { font-size: 1.6rem; }
    .history-row > td { padding: 12px 10px; font-size: .95rem; }
  }
</style>

<div class="container" style="max-width: 1100px; margin: 0 auto; padding: 8px 14px;">
  <div class="history-card">
    <h1 class="history-title">My Booking History</h1>
    <p class="history-subtitle">Track your bookings and see who played with you</p>

    <form method="get" class="filters-wrap">
      <label for="status" style="font-weight: 700; color:#374151;">Status</label>
      <select name="status" id="status" onchange="this.form.submit()">
        <option value="" {% if not status_filter %}selected{% endif %}>All</option>
        <option value="Pending" {% if status_filter == 'Pending' %}selected{% endif %}>Pending</option>
        <option value="Approved" {% if status_filter == 'Approved' %}selected{% endif %}>Approved</option>
        <option value="Rejected" {% if status_filter == 'Rejected' %}selected{% endif %}>Rejected</option>
      </select>
    </form>

    {% if page_obj.object_list %}
      <div class="table-responsive">
        <table class="history-table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Ground</th>
              <th>Sport</th>
              <th>Time Slot</th>
              <th>Players</th>
              <th>Status</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
            {% for b in page_obj.object_list %}
              <tr class="history-row">
                <td>{{ b.date }}</td>
                <td>Ground {{ b.ground }}</td>
                <td>{{ b.sport|default:'—' }}</td>
                <td>{{ b.time_slot }}</td>
                <td>{{ b.players.count }}</td>
                <td>
                  {% if b.status == 'Approved' %}
                    <span class="status-badge status-approved">Approved</span>
                  {% elif b.status == 'Rejected' %}
                    <span class="status-badge status-rejected">Rejected</span>
                  {% else %}
                    <span class="status-badge status-pending">Pending</span>
                  {% endif %}
                </td>
                <td style="text-align:right;">
                  <button class="players-toggle" type="button" data-target="players-{{ b.id }}">View Players</button>
                </td>
              </tr>
              <tr>
                <td colspan="7">
                  <div id="players-{{ b.id }}" class="players-panel">
                    {% if b.players.all %}
                      <div class="players-grid">
                        {% for p in b.players.all %}
                          <div class="player-chip">
                            <strong>{{ p.name }}</strong>
                            <span>
                              {% if p.branch %}{{ p.branch }}{% endif %}
                              {% if p.year %} • {{ p.year }}{% endif %}
                              {% if p.division %} • {{ p.division }}{% endif %}
                            </span>
                          </div>
                        {% endfor %}
                      </div>
                    {% else %}
                      <div style="color:#6b7280;">No player data available for this booking.</div>
                    {% endif %}
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      {% if page_obj.paginator.num_pages > 1 %}
      <div class="pagination">
        {% if page_obj.has_previous %}
          <a href="?page={{ page_obj.previous_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}">Previous</a>
        {% else %}
          <span class="btn" style="opacity:.5; pointer-events:none;">Previous</span>
        {% endif %}

        <span>Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}</span>

        {% if page_obj.has_next %}
          <a href="?page={{ page_obj.next_page_number }}{% if status_filter %}&status={{ status_filter }}{% endif %}">Next</a>
        {% else %}
          <span class="btn" style="opacity:.5; pointer-events:none;">Next</span>
        {% endif %}
      </div>
      {% endif %}

    {% else %}
      <div class="empty-state" style="padding:1rem; color:#6b7280;">
        No bookings found yet.
      </div>
    {% endif %}
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.players-toggle').forEach(btn => {
      btn.addEventListener('click', function () {
        const id = this.getAttribute('data-target');
        const panel = document.getElementById(id);
        if (!panel) return;
        const showing = panel.style.display === 'block';
        panel.style.display = showing ? 'none' : 'block';
        this.textContent = showing ? 'View Players' : 'Hide Players';
      });
    });
  });
</script>
{% endblock %}
